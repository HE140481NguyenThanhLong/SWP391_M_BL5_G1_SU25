<!DOCTYPE html>
<html lang="vi" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nh·∫≠p h√†ng - WinMart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        'primary-dark': '#059669',
                        'primary-light': '#34D399',
                        accent: '#F59E0B',
                        'accent-light': '#FCD34D',
                        neutral: {
                            50: '#F9FAFB',
                            100: '#F3F4F6',
                            200: '#E5E7EB',
                            300: '#D1D5DB',
                            400: '#9CA3AF',
                            500: '#6B7280',
                            600: '#4B5563',
                            700: '#374151',
                            800: '#1F2937',
                            900: '#111827'
                        }
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'display': ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="font-sans bg-neutral-50 text-neutral-800">
<!-- Header (gi·ªØ nguy√™n) -->
<div th:replace="~{component/header :: header}"></div>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-neutral-600 mb-8">
        <a href="#" class="text-primary hover:text-primary-dark">Home</a>
        <span>/</span>
        <a href="#" class="text-primary hover:text-primary-dark">Product</a>
        <span>/</span>
        <a href="#" class="text-primary hover:text-primary-dark">Product List</a>
        <span>/</span>
        <span class="text-neutral-800 font-medium">Import</span>
    </nav>

    <!-- Page Title -->
    <div class="mb-8">
        <h2 class="font-display text-4xl font-bold text-neutral-800 mb-2">Import ProDuck</h2>
        <p class="text-neutral-600">Qu·∫£n l√Ω nh·∫≠p h√†ng t·ª´ nh√† cung c·∫•p</p>
    </div>

    <!-- Import Section -->
    <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-8 mb-8">
        <button onclick="openSupplierModal()" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-primary-dark transition-colors flex items-center gap-2 mb-8">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Ch·ªçn s·∫£n ph·∫©m theo nh√† cung c·∫•p
        </button>

        <!-- Selected Products List -->
        <div class="mb-8">
            <h3 class="font-display text-2xl font-semibold text-neutral-800 mb-6">Danh s√°ch s·∫£n ph·∫©m ƒë√£ ch·ªçn</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                    <tr class="bg-neutral-100 border-b border-neutral-200">
                        <th class="text-left py-4 px-6 font-semibold text-neutral-800">T√™n</th>
                        <th class="text-left py-4 px-6 font-semibold text-neutral-800">Lo·∫°i s·∫£n ph·∫©m</th>
                        <th class="text-left py-4 px-6 font-semibold text-neutral-800">Gi√°</th>
                        <th class="text-left py-4 px-6 font-semibold text-neutral-800">S·ªë l∆∞·ª£ng</th>
                        <th class="text-left py-4 px-6 font-semibold text-neutral-800">Th√†nh ti·ªÅn</th>
                        <th class="text-left py-4 px-6 font-semibold text-neutral-800">X√≥a</th>
                    </tr>
                    </thead>
                    <tbody id="selectedProductsList">
                    <!-- Products will be added here dynamically -->
                    </tbody>
                </table>
            </div>
            <div id="emptyState" class="text-center py-12">
                <div class="text-6xl mb-4">üì¶</div>
                <h4 class="font-semibold text-neutral-600 mb-2">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn</h4>
                <p class="text-neutral-500">Nh·∫•n "Ch·ªçn s·∫£n ph·∫©m theo nh√† cung c·∫•p" ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
            </div>
        </div>

        <!-- Total and Actions -->
        <div class="border-t border-neutral-200 pt-6">
            <div class="flex items-center justify-between mb-6">
                <div class="text-2xl font-bold text-neutral-800">
                    T·ªïng ti·ªÅn: <span id="totalAmount" class="text-primary">0 VND</span>
                </div>
            </div>
            <button id="confirmBtn" onclick="confirmImport()" class="bg-primary text-white px-8 py-4 rounded-xl font-semibold hover:bg-primary-dark transition-colors ">
                X√°c nh·∫≠n
            </button>
        </div>
    </div>
</main>

<!-- Supplier Selection Modal -->
<div id="supplierModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-neutral-200">
                <div class="flex items-center justify-between">
                    <h3 class="font-display text-2xl font-bold text-neutral-800">Ch·ªçn s·∫£n ph·∫©m</h3>
                    <button onclick="closeSupplierModal()" class="text-neutral-400 hover:text-neutral-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <!-- Supplier Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-neutral-700 mb-2">Ch·ªçn nh√† cung c·∫•p</label>
                    <select id="supplierSelect" onchange="loadSupplierProducts()" class="w-full px-4 py-3 border border-neutral-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>
                        <!-- Suppliers will be loaded dynamically -->
                    </select>
                </div>
                <!-- Products Table -->
                <div id="productsTable" class="hidden">
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full">
                            <thead>
                            <tr class="bg-neutral-100 border-b border-neutral-200">
                                <th class="text-left py-4 px-6 font-semibold text-neutral-800">Ch·ªçn</th>
                                <th class="text-left py-4 px-6 font-semibold text-neutral-800">T√™n</th>
                                <th class="text-left py-4 px-6 font-semibold text-neutral-800">Lo·∫°i s·∫£n ph·∫©m</th>
                                <th class="text-left py-4 px-6 font-semibold text-neutral-800">Gi√°</th>
                            </tr>
                            </thead>
                            <tbody id="supplierProductsList">
                            <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="addSelectedProducts()" class="bg-primary text-white px-6 py-3 rounded-xl font-semibold hover:bg-primary-dark transition-colors">
                            Th√™m v√†o danh s√°ch
                        </button>
                        <button onclick="closeSupplierModal()" class="bg-neutral-500 text-white px-6 py-3 rounded-xl font-semibold hover:bg-neutral-600 transition-colors">
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>


    // Modal functions
    function openSupplierModal() {
        document.getElementById('supplierModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadSuppliers();
    }

    function closeSupplierModal() {
        document.getElementById('supplierModal').classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Load Suppliers v√†o select
    async function loadSuppliers() {
        try {
            const response = await fetch('/api/suppliers');
            if (!response.ok) {
                throw new Error(`API error: ${response.status} ${response.statusText}`);
            }
            const data = await response.json();
            const supplierSelect = document.getElementById('supplierSelect');
            supplierSelect.innerHTML = '<option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>';

            if (Array.isArray(data)) {
                data.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.supplier_id;
                    option.textContent = supplier.name;
                    supplierSelect.appendChild(option);
                });
            } else {
                throw new Error('D·ªØ li·ªáu nh√† cung c·∫•p kh√¥ng h·ª£p l·ªá');
            }
        } catch (error) {
            console.error('Error loading suppliers:', error);
            document.getElementById('supplierSelect').innerHTML = '<option value="">-- L·ªói t·∫£i d·ªØ li·ªáu --</option>';
        }
    }
     // Load Products theo Supplier
    async function loadSupplierProducts() {
        const supplier = document.getElementById('supplierSelect').value;
        const productsTable = document.getElementById('productsTable');
        const productsList = document.getElementById('supplierProductsList');

        productsTable.classList.add('hidden');
        productsList.innerHTML = '<tr><td colspan="4" class="py-4 px-6 text-center text-neutral-600">ƒêang t·∫£i s·∫£n ph·∫©m...</td></tr>';

        if (!supplier) {
            productsList.innerHTML = '<tr><td colspan="4" class="py-4 px-6 text-center text-neutral-600">Vui l√≤ng ch·ªçn nh√† cung c·∫•p</td></tr>';
            return;
        }

        try {
            const res = await fetch(`/api/suppliers/${supplier}/products`);
            const products = await res.json();

            if (!Array.isArray(products) || products.length === 0) {
                productsList.innerHTML = '<tr><td colspan="4" class="py-4 px-6 text-center text-neutral-600">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</td></tr>';
                productsTable.classList.remove('hidden');
                return;
            }

            productsList.innerHTML = '';
            products.forEach(product => {
                const categoryNames = Array.isArray(product.categories)
                    ? product.categories.join(', ')
                    : 'Kh√¥ng c√≥ danh m·ª•c';
                const row = document.createElement('tr');
                row.className = 'border-b border-neutral-100 hover:bg-neutral-50';
                row.innerHTML = `
                <td class="py-4 px-6">
                    <input type="checkbox" value="${product.product_id}" class="w-4 h-4 text-primary bg-neutral-100 border-neutral-300 rounded focus:ring-primary">
                </td>
                <td class="py-4 px-6 font-medium text-neutral-800">${product.name || 'Kh√¥ng c√≥ t√™n'}</td>
                <td class="py-4 px-6 text-neutral-600">${categoryNames}</td>
                <td class="py-4 px-6 text-primary font-semibold">${formatPrice(product.importPrice || product.price || 0)}</td>
            `;
                productsList.appendChild(row);
            });

            productsTable.classList.remove('hidden');
        } catch (error) {
            console.error('Error loading products:', error);
            productsList.innerHTML = `<tr><td colspan="4" class="py-4 px-6 text-center text-red-500">L·ªói t·∫£i s·∫£n ph·∫©m: ${error.message}</td></tr>`;
            productsTable.classList.remove('hidden');
        }
    }



    let selectedProducts = [];

    async function addSelectedProducts() {
        const checkboxes = document.querySelectorAll('#supplierProductsList input[type="checkbox"]:checked');
        const supplierId = document.getElementById('supplierSelect').value;

        if (!supplierId) {
            alert('Vui l√≤ng ch·ªçn nh√† cung c·∫•p tr∆∞·ªõc khi th√™m s·∫£n ph·∫©m.');
            return;
        }

        if (checkboxes.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m.');
            return;
        }

        for (const checkbox of checkboxes) {
            const productId = parseInt(checkbox.value);
            if (isNaN(productId)) {
                console.error(`Invalid productId for checkbox: ${checkbox.value}`);
                continue;
            }

            // Ch·ªâ push product_id, kh√¥ng push to√†n b·ªô object
            if (!selectedProducts.find(p => p.product_id === productId)) {
                selectedProducts.push({ product_id: productId });
                console.log(`‚úÖ Added productId ${productId}`);
            }
        }

        await updateSelectedProductsList();
        closeSupplierModal();
    }

    async function updateSelectedProductsList() {
        const tableBody = document.getElementById('selectedProductsList');
        const emptyState = document.getElementById('emptyState');

        tableBody.innerHTML = '';

        if (selectedProducts.length === 0) {
            emptyState.style.display = 'block';
            return;
        } else {
            emptyState.style.display = 'none';
        }

        for (const p of selectedProducts) {
            try {
                // ‚úÖ G·ªçi API l·∫•y chi ti·∫øt theo product_id
                const response = await fetch(`/product/api/products/${p.product_id}`);
                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const rawData = await response.json();
                const product = rawData.product ? rawData.product : rawData;

                const name = product.name ?? "Kh√¥ng r√µ";

                // ‚úÖ L·∫•y list categories
                const categories = Array.isArray(product.categories) && product.categories.length > 0
                    ? product.categories.join(', ')
                    : "Kh√¥ng c√≥ danh m·ª•c";

                const price = product.price ?? 0;

                // N·∫øu ch∆∞a c√≥ s·ªë l∆∞·ª£ng th√¨ m·∫∑c ƒë·ªãnh = 1
                if (!p.quantity) p.quantity = 1;

                const row = document.createElement('tr');
                row.className = 'border-b border-neutral-200 hover:bg-neutral-50';
                row.innerHTML = `
                <td class="py-3 px-6 font-medium text-neutral-800">${name}</td>
                <td class="py-3 px-6">${categories}</td>
                <td class="py-3 px-6 text-primary font-semibold">${formatPrice(price)}</td>
                <td class="py-3 px-6">
                    <input type="number" min="1" value="${p.quantity}"
                        class="w-20 border rounded px-2 py-1 text-center"
                        onchange="setQuantity(${p.product_id}, this.value)">
                </td>
                <td class="py-3 px-6 text-neutral-800 font-semibold">${formatPrice(price * p.quantity)}</td>
                <td class="py-3 px-6">
                    <button onclick="removeSelectedProduct(${p.product_id})"
                        class="text-red-500 hover:text-red-700">X√≥a</button>
                </td>
            `;
                tableBody.appendChild(row);

                // ‚úÖ L∆∞u gi√° v√†o selectedProducts ƒë·ªÉ d√πng khi submit
                p.price = price;

            } catch (error) {
                console.error(`‚ùå Error fetching product ${p.product_id}:`, error);
            }
        }
        updateTotal();
    }



    // H√†m x√≥a s·∫£n ph·∫©m kh·ªèi danh s√°ch ƒë√£ ch·ªçn
    function removeSelectedProduct(productId) {
        selectedProducts = selectedProducts.filter(p => p.product_id !== productId);
        updateSelectedProductsList();
    }
    // Quantity management functions
    function setQuantity(productId, newValue) {
        const product = selectedProducts.find(p => p.product_id === productId);
        if (product) {
            product.quantity = Math.max(1, Number(newValue)); // g√°n tr·ª±c ti·∫øp
            updateSelectedProductsList();
        }
    }
        function updateTotal() {
        const total = selectedProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
        document.getElementById('totalAmount').textContent = formatPrice(total);
    }

    // Format price function
    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(price).replace('‚Ç´', 'VND');
    }

    // Confirm import
    async function confirmImport() {
        if (selectedProducts.length === 0) return;

        try {
            const response = await fetch('/product/products/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(selectedProducts.map(product => ({
                    product_id: product.product_id,
                    quantity: product.quantity
                })))
            });

            if (response.ok) {
                alert('Nh·∫≠p h√†ng th√†nh c√¥ng!');
                selectedProducts = [];
                updateSelectedProductsList();
            } else {
                alert('C√≥ l·ªói x·∫£y ra khi nh·∫≠p h√†ng.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi nh·∫≠p h√†ng.');
        }
    }

    // Close modal when clicking outside
    document.getElementById('supplierModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeSupplierModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeSupplierModal();
        }
    });
</script>
</body>
</html>